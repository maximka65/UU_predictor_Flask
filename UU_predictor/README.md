# Описание работы каждого файла
## flask_server.py

Данный скрипт реализует сервер Flask, предназначенный для предсказания количества уникальных пользователей (Unique Users, UU) веб-сайта.

Файл состоит из нескольких ключевых частей:

- Импорт необходимых модулей и загрузка обученных моделей:

- В начале скрипта импортируются все необходимые библиотеки, а также загружаются обученные модели из соответствующих файлов .dill. Здесь используются три различные модели: forest_trained.dill для общего предсказания, visits_only.dill для предсказания на основе только посещений и alexa_visits.dill для предсказания на основе рейтинга Alexa и посещений.

    - Инициализация Flask-приложения:

    - Создается экземпляр Flask-приложения.

    - Определение маршрутов:

        - @app.route('/predictor'): Данный маршрут выводит простое приветствие для того, чтобы проверить работоспособность сервера.

        - @app.route('/predictor/predict', methods=['GET', 'POST']): Маршрут, обрабатывающий GET и POST запросы. В зависимости от полученных данных, выполняется предсказание количества уникальных пользователей с использованием одной из загруженных моделей. Если во входных данных отсутствуют значения для некоторых параметров, то они заменяются на -1 или 'Unknown'.

Запуск Flask-приложения:

- Приложение Flask запускается с параметрами threaded=False, processes=2, и host='0.0.0.0'. Это означает, что сервер будет принимать запросы на любой IP-адрес машины, на которой он запущен, и будет использовать 2 процесса для обработки входящих запросов.

Важно отметить, что в данном скрипте не происходит никакой предварительной обработки или очистки данных. 

## model.py

Файл model.py содержит код трех разных моделей, которые используются для предсказания количества уникальных пользователей веб-сайта. Это классы MetricaForest, MetricaVisitsOnly и MetricaAlexaVisits. Все они являются подклассами базового класса MetricaModel, который содержит общий код для предобработки данных.

#### Класс MetricaModel
MetricaModel – базовый класс, который предоставляет общий метод предобработки данных _preprocess(). Этот метод преобразует входные данные, заполняя пропуски и преобразуя категориальные переменные.

#### Класс MetricaForest
MetricaForest использует модель RandomForestRegressor из библиотеки sklearn.ensemble для предсказания количества уникальных пользователей. Данный класс имеет два метода:

- fit(data, data2=None): метод для обучения модели. Предобрабатывает входные данные с помощью _preprocess(), затем обучает две разные версии модели случайного леса: одну с использованием всех признаков, и другую без учета рейтинга Alexa.
- predict(data: list): метод для выполнения предсказания. Принимает список, содержащий данные для предсказания, и возвращает предсказанное количество уникальных пользователей.

#### Класс MetricaVisitsOnly
MetricaVisitsOnly использует модель LGBMRegressor из библиотеки lightgbm для предсказания количества уникальных пользователей, основываясь только на информации о количестве посещений.

- fit(data): метод для обучения модели. Предобрабатывает входные данные, затем обучает модель.
- predict(string: list): метод для выполнения предсказания.

#### Класс MetricaAlexaVisits
MetricaAlexaVisits использует модель RandomForestRegressor для предсказания количества уникальных пользователей на основе информации о количестве посещений и рейтинга Alexa.

- fit(data): метод для обучения модели. Предобрабатывает входные данные, затем обучает модель.
- predict(string: list): метод для выполнения предсказания.

## model_train.py

Этот файл представляет собой скрипт для обучения трех моделей, описанных в model.py, на различных наборах данных и сохранения обученных моделей в файлах с использованием библиотеки dill.

Сначала импортируются необходимые модули и классы моделей из model.py. Затем загружаются данные из JSON-файлов и подготавливаются к обучению моделей.
Обучение модели MetricaForest

- Данные из find_query_big.json и find_query (2).json считываются и объединяются.
- Инициализируется экземпляр класса MetricaForest и на нем вызывается метод fit(), передавая в него объединенные данные.
- После обучения модели она сохраняется в файл forest_trained.dill с использованием библиотеки dill.

#### Обучение модели MetricaVisitsOnly

- Данные из find_query_without_eng.json считываются в переменную data2.
- Инициализируется экземпляр класса MetricaVisitsOnly и на нем вызывается метод fit(), передавая в него data2.
- Обученная модель сохраняется в файл visits_only.dill.

#### Обучение модели MetricaAlexaVisits

- Данные из find_query (6).json считываются в переменную data3.
- Инициализируется экземпляр класса MetricaAlexaVisits и на нем вызывается метод fit(), передавая в него data3.
- Обученная модель сохраняется в файл alexa_visits.dill.

В результате выполнения этого скрипта у вас будет три файла с обученными моделями, которые затем можно использовать для предсказания количества уникальных пользователей на основе различных наборов признаков.

## utils.py
Файл utils.py содержит вспомогательные функции для предобработки и преобразования данных.

#### Функции

- visits(data): Функция для расчета неповторяющихся визитов за последний месяц. Принимает на вход DataFrame и возвращает список средних значений визитов для каждого сайта.

- unique_users(data): Функция для подсчета уникальных пользователей. Принимает на вход DataFrame и возвращает список с числом уникальных пользователей для каждого сайта.

- pages_per_visit(data): Функция для подсчета страниц за визит. Принимает на вход DataFrame и возвращает список со средним числом страниц, просмотренных за визит, для каждого сайта.

- bounce_rate(data): Функция для подсчета коэффициента отказов. Принимает на вход DataFrame и возвращает список коэффициентов отказов для каждого сайта.

- avg_visit_duration(data): Функция для подсчета средней продолжительности визита. Принимает на вход DataFrame и возвращает список со средней продолжительностью визита для каждого сайта.

- alexa(data): Функция для получения данных Alexa. Принимает на вход DataFrame и возвращает список значений Alexa Rank для каждого сайта.

- alexa_pop(data): Функция для получения данных о популярности Alexa. Принимает на вход DataFrame и возвращает список значений популярности Alexa для каждого сайта.

- category(data): Функция для определения категории сайта. Принимает на вход DataFrame и возвращает два списка с основной и второстепенной категорией каждого сайта.

- category_encoder(data): Функция для кодирования категорий сайта. Принимает на вход DataFrame и возвращает строку, которая содержит данные сайта и бинарные признаки, отражающие его принадлежность к определенной категории.

Все функции обрабатывают исключения и возвращают специальное значение (-1), когда не могут обработать данные из-за отсутствия данных или ошибки формата данных.

## Dockerfile
Dockerfile - это файл конфигурации для Docker, который содержит инструкции о том, как собрать Docker-образ для проекта.

#### структура
- Стартует с базового образа python версии 3.6
- Создает директорию /app внутри контейнера и делает её рабочей директорией
- Копирует содержимое текущей директории на хосте в /app внутри контейнера
- Устанавливает зависимости Python из файла requirements.txt
- Объявляет порт 5000 для контейнера
- Запускает сервер Gunicorn при старте контейнера.

## .gitlab-ci.yml
Это файл конфигурации для Gitlab CI/CD. В этом файле определены шаги, которые будут выполняться в процессе непрерывной интеграции и развертывания.

#### структура

- Определяются два основных этапа: docker-build и docker-deploy.
- Docker-build собирает Docker-образ на основе нашего Dockerfile и пушит его в Docker-реестр.
- Docker-deploy подключается к целевому серверу по SSH, удаляет предыдущий Docker-контейнер, загружает новый Docker-образ из реестра и запускает его.
- Настройка переменных окружения зависит от ветки Git: main для продакшна, staging для стейджинга.

## requirements.txt

Это файл, который содержит список зависимостей Python, которые необходимы для работы нашего приложения. Все эти зависимости будут автоматически установлены во время сборки Docker-образа при помощи команды pip install -r requirements.txt.

#### Список включает в себя:

- dill
- pandas
- flask==2.0.0
- numpy
- sklearn
- lightgbm
- gunicorn
- gevent
- catboost

Эти библиотеки используются для обучения модели, запуска веб-сервера и обработки данных.
